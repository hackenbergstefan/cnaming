#!/usr/bin/env python
import argparse
import importlib
import os
import pkgutil
import sys

import cnaming
import cnaming.rules


def main():
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument('ruleset', help='''Ruleset to check against.
    Either file containing rules or name of contained ruleset.
    Contained rulesets: ''' + ', '.join('"{}"'.format(p.name) for p in pkgutil.walk_packages(cnaming.rules.__path__)))
    parser.add_argument('file', help='File to check.')
    args = parser.parse_args()

    # Get ruleset
    if os.path.exists(args.ruleset):
        locs = {}
        exec(open(args.ruleset).read(), {}, locs)
        ruleset = locs['ruleset']
    else:
        mod = importlib.import_module('cnaming.rules.' + args.ruleset)
        ruleset = mod.ruleset

    # Check file
    result = cnaming.NamingCheck(ruleset).check(os.path.abspath(args.file))

    for res in result:
        print('{}:{}:"{}": {}'.format(
            res.node.location.line,
            res.node.location.column,
            str(res.node),
            res.text,
        ))

    if len(result) > 0:
        sys.exit(1)


if __name__ == '__main__':
    main()
